<UserControl x:Class="OfflineProjectManager.Views.ProjectExplorerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:vm="clr-namespace:OfflineProjectManager.Features.Project.ViewModels"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="300"
             Background="{DynamicResource SidebarBrush}"
             Focusable="True">
    
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <!-- Retain any existing merged dictionaries if present implicitly, or just add local resources -->
            </ResourceDictionary.MergedDictionaries>
            
            <HierarchicalDataTemplate DataType="{x:Type vm:FileNode}" ItemsSource="{Binding Children}">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{Binding Converter={StaticResource FileToIconConverter}}" 
                          Fill="{DynamicResource ForegroundBrush}" 
                          Stretch="Uniform" Height="14" Width="14" Margin="0,0,6,0" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding Name}" Margin="0,2"/>
                </StackPanel>
            </HierarchicalDataTemplate>
        </ResourceDictionary>
    </UserControl.Resources>

    <UserControl.CommandBindings>
        <CommandBinding Command="ApplicationCommands.Find" Executed="Find_Executed"/>
    </UserControl.CommandBindings>
    
    <UserControl.InputBindings>
        <KeyBinding Command="ApplicationCommands.Find" Gesture="Ctrl+F"/>
    </UserControl.InputBindings>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Search Box -->
        <Grid Grid.Row="0" Margin="5">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
            <Grid>
                <TextBox x:Name="SearchTextBox" Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}" 
                         Height="25" VerticalContentAlignment="Center" 
                         Background="{DynamicResource InputBackgroundBrush}" 
                         Foreground="{DynamicResource ForegroundBrush}" 
                         BorderBrush="{DynamicResource BorderBrush}"
                         ToolTip="Search files (supports Vietnamese)">
                    <TextBox.InputBindings>
                        <KeyBinding Key="Return" Command="{Binding SearchCommand}"/>
                    </TextBox.InputBindings>
                </TextBox>
                <!-- Placeholder -->
                <TextBlock Text="Search..." VerticalAlignment="Center" Margin="5,0,0,0" IsHitTestVisible="False" Visibility="Collapsed">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Foreground" Value="#888888"/>
                            <Setter Property="Opacity" Value="0.5"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Text, ElementName=SearchTextBox}" Value="">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </Grid>
                <Button Grid.Column="1" Command="{Binding SearchCommand}" Content="Go" Width="40" Margin="5,0,0,0"/>
            </Grid>
            
            <!-- Search Result Counter -->
            <TextBlock Grid.Row="1" Text="{Binding SearchResultCount}" 
                       Margin="2,3,0,0" FontSize="11" 
                       Opacity="0.7"
                       Foreground="{DynamicResource ForegroundBrush}" 
                       Visibility="{Binding SearchResultCount, Converter={StaticResource StringToVisibilityConverter}}"/>
        </Grid>

        <!-- Tree View -->
        <TreeView x:Name="treeView" Grid.Row="1" ItemsSource="{Binding Nodes}" 
                  Background="Transparent" BorderThickness="0" 
                  Foreground="{DynamicResource ForegroundBrush}"
                  VirtualizingStackPanel.IsVirtualizing="True"
                  VirtualizingStackPanel.VirtualizationMode="Recycling"
                  ScrollViewer.HorizontalScrollBarVisibility="Auto"
                  ScrollViewer.VerticalScrollBarVisibility="Auto"
                  ScrollViewer.CanContentScroll="True">
            <TreeView.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="Add Folder" Command="{Binding PlacementTarget.DataContext.AddFolderCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                </ContextMenu>
            </TreeView.ContextMenu>

            <TreeView.ItemContainerStyle>
                <Style TargetType="TreeViewItem">
                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                    <Setter Property="Foreground" Value="{StaticResource ForegroundBrush}"/>
                    <!-- Bind Tag to the TreeView's DataContext (ProjectExplorerViewModel) so ContextMenu can access it -->
                    <Setter Property="Tag" Value="{Binding DataContext, RelativeSource={RelativeSource AncestorType=TreeView}}"/>
                    <Setter Property="ContextMenu">
                        <Setter.Value>
                            <ContextMenu>
                                <!-- Folder Actions -->
                                <MenuItem Header="Add File"
                                          Command="{Binding PlacementTarget.Tag.AddFileCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                          CommandParameter="{Binding}"
                                          Visibility="{Binding Type, Converter={StaticResource NodeTypeToVisibilityConverter}, ConverterParameter=Folder}"/>
                                <MenuItem Header="Remove Folder" 
                                          Command="{Binding PlacementTarget.Tag.RemoveFolderCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                          CommandParameter="{Binding}"
                                          Visibility="{Binding Type, Converter={StaticResource NodeTypeToVisibilityConverter}, ConverterParameter=Folder}"/>
                                <Separator Visibility="{Binding Type, Converter={StaticResource NodeTypeToVisibilityConverter}, ConverterParameter=Folder}"/>
                                <MenuItem Header="Search in This Folder" 
                                          Command="{Binding PlacementTarget.Tag.SearchInFolderCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                          CommandParameter="{Binding}"
                                          Visibility="{Binding Type, Converter={StaticResource NodeTypeToVisibilityConverter}, ConverterParameter=Folder}"/>
                                
                                <!-- File Actions -->
                                <MenuItem Header="Open File" 
                                          Command="{Binding PlacementTarget.Tag.OpenFileCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                          CommandParameter="{Binding}"
                                          Visibility="{Binding Type, Converter={StaticResource NodeTypeToVisibilityConverter}, ConverterParameter=File}"/>
                                <MenuItem Header="Open Containing Folder" 
                                          Command="{Binding PlacementTarget.Tag.OpenContainingFolderCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                          CommandParameter="{Binding}"
                                          Visibility="{Binding Type, Converter={StaticResource NodeTypeToVisibilityConverter}, ConverterParameter=File}"/>
                                <Separator Visibility="{Binding Type, Converter={StaticResource NodeTypeToVisibilityConverter}, ConverterParameter=File}"/>
                                <MenuItem Header="Add Task" 
                                          Command="{Binding PlacementTarget.Tag.CreateTaskCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                          CommandParameter="{Binding}"
                                          Visibility="{Binding Type, Converter={StaticResource NodeTypeToVisibilityConverter}, ConverterParameter=File}"/>
                            </ContextMenu>
                        </Setter.Value>
                    </Setter>
                </Style>
            </TreeView.ItemContainerStyle>
            
            <i:Interaction.Triggers>
                <i:EventTrigger EventName="SelectedItemChanged">
                    <i:InvokeCommandAction Command="{Binding FileSelectedCommand}" CommandParameter="{Binding SelectedItem, ElementName=treeView}"/>
                </i:EventTrigger>
            </i:Interaction.Triggers>
        </TreeView>
    </Grid>
</UserControl>
